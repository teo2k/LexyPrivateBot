from __future__ import annotations

from typing import List, Dict, Any
import json

from openai import OpenAI
from config import settings


_client: OpenAI | None = None


def get_client() -> OpenAI:
    global _client
    if _client is None:
        _client = OpenAI(api_key=settings.openai_api_key)
    return _client


async def get_embedding(text: str, model: str = "text-embedding-3-small") -> List[float]:
    client = get_client()
    resp = client.embeddings.create(
        model=model,
        input=text,
    )
    return resp.data[0].embedding  # type: ignore[no-any-return]


async def analyze_fragment_with_norms(
    fragment_text: str,
    norms: List[Dict[str, Any]],
    model: str = "gpt-5.1",
) -> Dict[str, Any]:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É —Ç–∞–±–ª–∏—á–Ω–æ–π —Å—Ö–µ–º—ã.

    –í–û–ó–í–†–ê–©–ê–ï–ú –°–¢–ê–†–£–Æ, –°–¢–ê–ë–ò–õ–¨–ù–£–Æ –°–•–ï–ú–£:

    {
      "label": "OK" | "–†–∏—Å–∫",
      "comment": "1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —Å—É—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è (–∏–ª–∏ –ø–æ—á–µ–º—É –µ–≥–æ –Ω–µ—Ç)",
      "correct_position": "–∫—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∑–∞–∫–æ–Ω—É/–í–° –†–§",
      "source_indices": [0, 2, ...]
    }
    """

    client = get_client()

    # –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–æ—Ä–º —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
    norms_lines = []
    for i, n in enumerate(norms):
        norms_lines.append(
            f"[{i}] {n.get('type')} {n.get('number')}: "
            f"{n.get('short_title')} ‚Äî {n.get('summary')}"
        )
    norms_text = "\n".join(norms_lines) if norms_lines else "–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ—Ä–º"

    # üîπ –†–û–í–ù–û –¢–û–¢ –¢–ï–ö–°–¢, –ö–û–¢–û–†–´–ô –¢–´ –ü–†–û–°–ò–õ, –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
    system_msg = (
        "–ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—á–Ω–æ–π —Å—Ö–µ–º—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞\n\n"
        "–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤\n\n"
        "–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å 4 –∫–æ–ª–æ–Ω–∫–∞–º–∏:\n\n"
        "‚Ññ –ø/–ø\n\n"
        "–ü—Ä–æ–µ–∫—Ç –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–û—à–∏–±–æ—á–Ω—ã–π —Ç–µ–∑–∏—Å)\n\n"
        "–î–µ–π—Å—Ç–≤—É—é—â–∞—è –Ω–æ—Ä–º–∞ / –ü–æ–∑–∏—Ü–∏—è –í–° –†–§\n\n"
        "–í—ã–≤–æ–¥\n\n"
        "–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:\n\n"
        "–ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–¥–µ–∫—Å –†–§\n\n"
        "–ü—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ –∫–æ–¥–µ–∫—Å—ã (–ì–ü–ö, –ê–ü–ö, –ö–ê–°)\n\n"
        "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ü–ª–µ–Ω—É–º–∞ –í–° –†–§\n\n"
        "–û–±–∑–æ—Ä—ã —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –í–° –†–§\n\n"
        "–®–∞–≥ 2: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞\n"
        "3. –†–∞–∑–±–µ–π—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏ (–ø–æ –ø—É–Ω–∫—Ç–∞–º)\n"
        "4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ:\n"
        "* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞–º –∫–æ–¥–µ–∫—Å–æ–≤\n"
        "* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–µ –í–° –†–§\n"
        "* –ü–æ–ª–Ω–æ—Ç—É –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–æ–≤—ã—Ö –Ω–æ—Ä–º\n"
        "* –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π\n\n"
        "–®–∞–≥ 3: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã—è–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è)\n"
        "5. –ö–æ–ª–æ–Ω–∫–∞ \"–ü—Ä–æ–µ–∫—Ç –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è\":\n"
        "* –î–æ—Å–ª–æ–≤–Ω–æ –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç\n"
        "* –ò–õ–ò –∫—Ä–∞—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –æ—à–∏–±–æ—á–Ω—ã–π —Ç–µ–∑–∏—Å\n"
        "* *–ü—Ä–∏–º–µ—Ä: ¬´–≥–æ—Å–ø–æ—à–ª–∏–Ω–∞ –∑–∞ –∫–∞—Å—Å–∞—Ü–∏—é: —Ñ–∏–∑–ª–∏—Ü–∞ - 7 000 —Ä—É–±.¬ª*\n\n"
        "–ö–æ–ª–æ–Ω–∫–∞ \"–î–µ–π—Å—Ç–≤—É—é—â–∞—è –Ω–æ—Ä–º–∞ / –ü–æ–∑–∏—Ü–∏—è –í–° –†–§\":\n\n"
        "–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é –∫–æ–¥–µ–∫—Å–∞ —Å –Ω–æ–º–µ—Ä–æ–º –ø—É–Ω–∫—Ç–∞\n\n"
        "–ò–õ–ò –Ω–æ–º–µ—Ä –∏ –ø—É–Ω–∫—Ç –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ü–ª–µ–Ω—É–º–∞ –í–° –†–§\n\n"
        "–ò–õ–ò –Ω–æ–º–µ—Ä –û–±–∑–æ—Ä–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏ –í–° –†–§\n\n"
        "–ü—Ä–∏–º–µ—Ä: ¬´–ø–ø. 12 –ø. 1 —Å—Ç. 333.19 –ù–ö –†–§: 3 000 —Ä—É–±.¬ª\n\n"
        "–ö–æ–ª–æ–Ω–∫–∞ \"–í—ã–≤–æ–¥\":\n\n"
        "–î–∞–π—Ç–µ –∫—Ä–∞—Ç–∫—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é:\n\n"
        "\"–ü—Ä—è–º–æ–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –ù–ö –†–§\"\n\n"
        "\"–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–µ –í–° –†–§\"\n\n"
        "\"–ù–µ–ø–æ–ª–Ω–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –Ω–æ—Ä–º—ã\"\n\n"
        "\"–í–≤–æ–¥—è—â–µ–µ –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ\"\n\n"
        "–®–∞–≥ 4: –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞\n"
        "8. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã –Ω–∞:\n"
        "* –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n"
        "* –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –Ω–æ—Ä–º\n"
        "* –õ–æ–≥–∏—á–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–∞\n"
        "* –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤\n\n"
        "–®–∞–≥ 5: –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏\n"
        "9. –†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ –≤–∞–∂–Ω–æ—Å—Ç–∏:\n"
        "* –ü—Ä—è–º—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –∫–æ–¥–µ–∫—Å–∞–º\n"
        "* –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –ø—Ä–∞–∫—Ç–∏–∫–µ –í–° –†–§\n"
        "* –ù–µ–ø–æ–ª–Ω–æ—Ç–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è\n"
        "* –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏\n"
    )

    # üîπ –∑–¥–µ—Å—å –æ–±—ä—è—Å–Ω—è–µ–º, –ö–ê–ö –≠–¢–û –õ–û–ñ–ò–¢–°–Ø –í JSON
    user_msg = (
        "–¢—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–∏–º–µ–Ω—è–π –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã–π –≤—ã—à–µ –∞–ª–≥–æ—Ä–∏—Ç–º –∫ –¥–∞–Ω–Ω–æ–º—É —Ñ—Ä–∞–≥–º–µ–Ω—Ç—É.\n\n"
        "–£ —Ç–µ–±—è –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–Ω–æ—Ä–º –∏ –ø–æ–∑–∏—Ü–∏–π –í–° –†–§), "
        "–∫–æ—Ç–æ—Ä—ã–º–∏ –ú–û–ñ–ù–û –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è. –ù–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è. "
        "–ù–µ–ª—å–∑—è –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏, –ø—É–Ω–∫—Ç—ã, –Ω–æ–º–µ—Ä–∞ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –∏–ª–∏ –æ–±–∑–æ—Ä–æ–≤.\n\n"
        "–§—Ä–∞–≥–º–µ–Ω—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:\n"
        "-----------------\n"
        f"{fragment_text}\n"
        "-----------------\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ—Ä–º—ã –∏ –ø–æ–∑–∏—Ü–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏):\n"
        f"{norms_text}\n\n"
        "–í–Ω—É—Ç—Ä–∏ —Å–≤–æ–µ–π –ª–æ–≥–∏–∫–∏ —Ç—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—à—å —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã:\n"
        "- ¬´–ü—Ä–æ–µ–∫—Ç –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–û—à–∏–±–æ—á–Ω—ã–π —Ç–µ–∑–∏—Å)¬ª ‚Äî —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏–ª–∏ –µ–≥–æ –∫—Ä–∞—Ç–∫–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞,\n"
        "- ¬´–î–µ–π—Å—Ç–≤—É—é—â–∞—è –Ω–æ—Ä–º–∞ / –ü–æ–∑–∏—Ü–∏—è –í–° –†–§¬ª ‚Äî —ç—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è/–ø—É–Ω–∫—Ç –∫–æ–¥–µ–∫—Å–∞ –∏–ª–∏ –ü–ª–µ–Ω—É–º–∞/–û–±–∑–æ—Ä–∞,\n"
        "- ¬´–í—ã–≤–æ–¥¬ª ‚Äî —ç—Ç–æ –∫—Ä–∞—Ç–∫–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: "
        "¬´–ü—Ä—è–º–æ–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –ù–ö –†–§¬ª, ¬´–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–µ –í–° –†–§¬ª, "
        "¬´–ù–µ–ø–æ–ª–Ω–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –Ω–æ—Ä–º—ã¬ª, ¬´–í–≤–æ–¥—è—â–µ–µ –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ¬ª.\n\n"
        "–ù–æ –û–¢–í–ï–¢ –¢–´ –î–ê–Å–®–¨ –°–¢–†–û–ì–û –í –í–ò–î–ï JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:\n\n"
        "{\n"
        '  \"label\": \"–†–∏—Å–∫\" –∏–ª–∏ \"OK\",  // \"–†–∏—Å–∫\" ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ/–æ—à–∏–±–∫–∞; \"OK\" ‚Äî –µ—Å–ª–∏ –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ\n'
        '  \"comment\": \"1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —Å—É—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –∏–ª–∏ –ø–æ—á–µ–º—É –µ–≥–æ –Ω–µ—Ç\",\n'
        '  \"correct_position\": \"–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ –∑–∞–∫–æ–Ω—É/–í–° –†–§, —Å –æ–ø–æ—Ä–æ–π –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã\",\n'
        '  \"source_indices\": [0, 2, ...]  // –∏–Ω–¥–µ–∫—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ\n'
        "}\n\n"
        "–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:\n"
        "- –µ—Å–ª–∏ –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É —Ç—ã –Ω–∞—Ö–æ–¥–∏—à—å –ø—Ä—è–º–æ–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ, –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–µ –í–° –†–§, –Ω–µ–ø–æ–ª–Ω–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ "
        "–∏–ª–∏ –≤–≤–æ–¥—è—â–µ–µ –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ ‚Äî —Å—Ç–∞–≤—å label = \"–†–∏—Å–∫\";\n"
        "- –µ—Å–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ—Ä–º–∞–º –∏ –ø—Ä–∞–∫—Ç–∏–∫–µ –í–° –†–§ –∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ ‚Äî —Å—Ç–∞–≤—å label = \"OK\".\n\n"
        "–ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –Ω–æ—Ä–º —Å—Ä–µ–¥–∏ —Å–ø–∏—Å–∫–∞ –Ω–µ—Ç –∏ –Ω–µ–ª—å–∑—è —É–≤–µ—Ä–µ–Ω–Ω–æ –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ, "
        "—Å—Ç–∞–≤—å label = \"OK\" –∏ –ø—Ä—è–º–æ —É–∫–∞–∂–∏ –≤ comment, —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞.\n\n"
        "–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON."
    )

    resp = client.chat.completions.create(
        model=model,
        messages=[
            {"role": "system", "content": system_msg},
            {"role": "user", "content": user_msg},
        ],
        temperature=0.0,
    )

    content = resp.choices[0].message.content or "{}"

    try:
        data = json.loads(content)
        if not isinstance(data, dict):
            raise ValueError("LLM returned non-dict JSON")

        # –¥–µ—Ñ–æ–ª—Ç—ã –∏ –±–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if data.get("label") not in ("OK", "–†–∏—Å–∫"):
            data["label"] = "OK"

        data.setdefault("comment", "")
        data.setdefault("correct_position", "")

        if not isinstance(data.get("source_indices"), list):
            data["source_indices"] = []

        return data

    except Exception:
        # fallback, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–ª–æ–º–∞–ª–∞ —Ñ–æ—Ä–º–∞—Ç
        return {
            "label": "OK",
            "comment": (
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏. "
                "–°—á–∏—Ç–∞–µ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç —É—Å–ª–æ–≤–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º (–±–µ–∑ —è–≤–Ω–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è)."
            ),
            "correct_position": "",
            "source_indices": [],
        }
